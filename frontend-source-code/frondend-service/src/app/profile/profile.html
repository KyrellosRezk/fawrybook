<div class="min-h-screen bg-gray-950 text-gray-100 p-6">
  <div class="max-w-4xl mx-auto bg-gray-900 p-6 rounded-xl shadow-lg">
    <div class="flex justify-between items-center">
      <div class="flex flex-col md:flex-row items-center md:items-start gap-6">
        <img
          [src]="profileUser.logoPath || 'assets/default-avatar.png'"
          alt="Profile"
          class="w-32 h-32 rounded-full border-4 border-gray-700"
        />
        <div>
          <!-- ‚úÖ Full Name -->
          <h2 class="text-2xl font-semibold !text-gray-100">
            {{ profileUser.firstName }} {{ profileUser.middleName }} {{ profileUser.lastName }}
          </h2>

          <!-- ‚úÖ Username -->
          <p class="text-blue-400 mt-1 text-sm">@{{ profileUser.username }}</p>

          <!-- ‚úÖ Position & Governorate -->
          <p class="text-gray-400 mt-2">
            {{ profileUser.position?.name }} - {{ profileUser.governorate?.name }}
          </p>

          <!-- ‚úÖ E-mail -->
          <p class="text-sm text-gray-500 mt-2">üìß {{ profileUser.email }}</p>
        </div>
      </div>

      @if (profileUserId === signedUser.id) {
      <button
        class="px-4 py-2 bg-red-500 rounded-lg h-fit cursor-pointer"
        (click)="openFriendRequestsDialog()"
      >
        Follow Requests
      </button>
      }
    </div>

    <div class="mt-8 border-t border-gray-800 pt-4">
      <h3 class="text-xl font-semibold mb-4 !text-gray-200">Recent Posts</h3>

      @if (loading) {
      <!-- üî∏ Skeletons while loading -->
      @for (skeleton of [1, 2, 3]; track skeleton) {
      <div class="animate-pulse bg-gray-900 shadow rounded-lg p-4 mb-6">
        <div class="flex items-center mb-3">
          <div class="w-10 h-10 bg-gray-700 rounded-full mr-3"></div>
          <div class="flex-1">
            <div class="h-3 bg-gray-700 rounded w-1/3 mb-2"></div>
            <div class="h-2 bg-gray-800 rounded w-1/4"></div>
          </div>
        </div>
        <div class="h-3 bg-gray-700 rounded mb-2"></div>
        <div class="h-3 bg-gray-800 rounded w-5/6"></div>
      </div>
      } } @else {
      <!-- üî∏ Loaded Posts -->
      @for (post of posts; track post.id) {
      <div class="bg-gray-900 shadow rounded-lg p-4 mb-6 flex justify-between items-end">
        <div>
          <div class="flex justify-between items-center">
            <div class="flex items-center mb-3">
              <img
                [src]="profileUser.logoPath || 'assets/default-avatar.png'"
                class="w-10 h-10 rounded-full mr-3 border border-gray-700"
                alt="Profile"
              />
              <div>
                <h4 class="font-medium !text-gray-200">
                  {{ post.user.firstName }} {{ post.user.middleName }}
                </h4>
              </div>
            </div>
            @if (signedUser.id === profileUserId) {
            <div class="flex gap-2 items-center">
              <mat-icon
                class="cursor-pointer text-gray-400 hover:text-blue-400 transition"
                (click)="openEditDialog(post.id)"
              >
                edit
              </mat-icon>
              <mat-icon
                class="cursor-pointer text-gray-400 hover:text-red-400 transition"
                (click)="deletePost(post.id)"
              >
                delete
              </mat-icon>
            </div>
            }
          </div>
          <p class="text-gray-300">{{ post.content }}</p>

          <!-- ‚úÖ Media display -->
          @if (post.mediaPaths.length === 1) {
          <div class="grid grid-cols-1 gap-2 mt-3">
            <img [src]="post.mediaPaths[0]" class="w-full rounded-lg object-cover" />
          </div>
          } @else if (post.mediaPaths.length === 2) {
          <div class="grid grid-cols-2 gap-2 mt-3">
            @for (img of post.mediaPaths; track img) {
            <img [src]="img" class="w-full h-64 object-cover rounded-lg" />
            }
          </div>
          } @else if (post.mediaPaths.length === 3) {
          <div class="grid grid-cols-2 gap-2 mt-3">
            <img
              [src]="post.mediaPaths[0]"
              class="w-full h-64 object-cover rounded-lg col-span-2"
            />
            <img [src]="post.mediaPaths[1]" class="w-full h-48 object-cover rounded-lg" />
            <img [src]="post.mediaPaths[2]" class="w-full h-48 object-cover rounded-lg" />
          </div>
          } @else if (post.mediaPaths.length > 3) {
          <div class="grid grid-cols-2 gap-2 mt-3">
            <!-- üñºÔ∏è Show first 3 images -->
            @for (img of post.mediaPaths.slice(0, 3); track img) {
            <img [src]="img" class="w-full h-60 object-cover rounded-lg" />
            }

            <!-- üü¶ The clickable "+N" overlay -->
            @if (!post.expanded) {
            <div
              class="relative w-full h-60 rounded-lg overflow-hidden cursor-pointer hover:opacity-90 transition"
              (click)="post.expanded = true"
            >
              <img [src]="post.mediaPaths[3]" class="w-full h-full object-cover" />
              <div
                class="absolute inset-0 bg-black bg-opacity-70 flex items-center justify-center text-white text-3xl font-semibold"
              >
                +{{ post.mediaPaths.length - 4 }}
              </div>
            </div>
            }
          </div>

          <!-- üü© Expanded view when clicked -->
          @if (post.expanded) {
          <div class="grid grid-cols-2 gap-2 mt-3">
            @for (img of post.mediaPaths.slice(3); track img) {
            <img [src]="img" class="w-full h-60 object-cover rounded-lg" />
            }
          </div>

          <!-- üîΩ Optional collapse button -->
          <button
            class="text-blue-400 mt-2 text-sm underline cursor-pointer"
            (click)="post.expanded = false"
          >
            Show less
          </button>
          } }

          <div class="flex gap-5 mt-3">
            <span
              class="flex gap-2 justify-center items-center text-base font-semibold cursor-pointer text-blue-400 hover:bg-gray-800 p-2 rounded-xl"
            >
              <i-lucide [img]="comment"></i-lucide>
              Comments
              <span class="text-blue-300 border border-gray-700 rounded-xl p-2">{{
                post.commentsCount
              }}</span>
            </span>

            <span
              class="flex gap-2 justify-center items-center text-base font-semibold cursor-pointer text-green-400 hover:bg-gray-800 p-2 rounded-xl"
            >
              <i-lucide [img]="like"></i-lucide>
              Likes
              <span class="text-green-300 border border-gray-700 rounded-xl p-2">{{
                post.likeCount
              }}</span>
            </span>

            <span
              class="flex gap-2 justify-center items-center text-base font-semibold cursor-pointer text-red-400 hover:bg-gray-800 p-2 rounded-xl"
            >
              <i-lucide [img]="dislike"></i-lucide>
              Dislikes
              <span class="text-red-300 border border-gray-700 rounded-xl p-2">{{
                post.disLikeCount
              }}</span>
            </span>
          </div>
        </div>
      </div>
      } }
    </div>

    <!-- üîπ Pagination Controls -->
    <div class="flex justify-between items-center mt-6 border-t border-gray-800 pt-4">
      <button
        class="px-4 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 text-gray-200 disabled:opacity-50"
        [disabled]="currentPostPage === 0"
        (click)="loadPost(currentPostPage - 1)"
      >
        ‚Üê Previous
      </button>

      <div class="text-gray-400 text-sm">Page {{ currentPostPage + 1 }} of {{ postsPages }}</div>

      <button
        class="px-4 py-2 bg-gray-800 rounded-lg hover:bg-gray-700 text-gray-200 disabled:opacity-50"
        [disabled]="currentPostPage + 1 >= postsPages"
        (click)="loadPost(currentPostPage + 1)"
      >
        Next ‚Üí
      </button>
    </div>

    <div class="w-full">
      <button
        routerLink="/"
        class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg transition cursor-pointer w-full"
        (click)="goToFeed()"
      >
        Back to Feed
      </button>
    </div>
  </div>
</div>

<!-- ‚úèÔ∏è Edit Dialog -->
<ng-template #editDialogComponent let-dialogRef>
  <h2 mat-dialog-title>Edit Post</h2>
  <mat-dialog-content>
    <mat-form-field appearance="fill" class="w-full">
      <mat-label>Post Content</mat-label>
      <input matInput [(ngModel)]="editedContent" placeholder="Edit your post" />
    </mat-form-field>
  </mat-dialog-content>
  <mat-dialog-actions>
    <div class="w-full flex justify-center gap-10">
      <button mat-button (click)="dialog.closeAll()">Cancel</button>
      <button mat-raised-button color="primary" (click)="saveEdit(selectedPostId)">Save</button>
    </div>
  </mat-dialog-actions>
</ng-template>

<!-- üü¶ Follow Requests Dialog -->
<ng-template #friendRequestsDialog>
  <h2 mat-dialog-title class="text-xl font-semibold text-gray-100">Follow Requests</h2>
  <mat-dialog-content class="bg-gray-900 p-4 rounded-lg text-gray-200">
    @if (friendRequests.length > 0) { @for (request of friendRequests; track request.id) {
    <div class="flex items-center justify-between p-3 bg-gray-800 rounded-lg mb-3">
      <div class="flex items-center gap-3">
        <img
          [src]="request.logoPath || 'assets/default-avatar.png'"
          alt="Avatar"
          class="w-10 h-10 rounded-full border border-gray-700 cursor-pointer"
          (click)="goToProfile(request.id)"
        />
        <div>
          <h4 class="font-medium text-gray-100 cursor-pointer" (click)="goToProfile(request.id)">
            {{ request.firstName }} {{ request.middleName }} {{ request.lastName }}
          </h4>
        </div>
      </div>
      <div class="flex gap-2">
        <button mat-stroked-button color="primary" (click)="acceptRequest(request.id)">
          Confirm
        </button>
        <button mat-stroked-button color="warn" (click)="declineRequest(request.id)">Delete</button>
      </div>
    </div>
    } } @else {
    <p class="text-gray-400 text-center mt-6 p-5">No new follow requests</p>
    }
  </mat-dialog-content>

  <mat-dialog-actions align="end">
    <button mat-button (click)="dialog.closeAll()">Close</button>
  </mat-dialog-actions>
</ng-template>
